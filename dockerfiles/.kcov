FROM debian:10-slim AS builder

ARG VERSION=v36

RUN apt-get update && apt-get install -y \
      build-essential cmake ninja-build python \
      binutils-dev libcurl4-openssl-dev zlib1g-dev libdw-dev libiberty-dev

WORKDIR /usr/local/src
ADD https://github.com/SimonKagstrom/kcov/archive/$VERSION.tar.gz /
RUN tar xzf /$VERSION.tar.gz -C ./ --strip-components 1 \
 && mkdir build && cd build \
 && cmake -G 'Ninja' .. && cmake --build . --target install

FROM debian:10-slim
RUN apt-get update && apt-get install -y binutils libcurl4 zlib1g libdw1
COPY --from=builder /usr/local/bin/kcov* /usr/local/bin/
COPY --from=builder /usr/local/share/doc/kcov /usr/local/share/doc/kcov

CMD ["/usr/local/bin/kcov"]
