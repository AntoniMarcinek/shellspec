ARG IMAGE

FROM shellspec:helpers as helpers

FROM $IMAGE
COPY --from=helpers /usr/local/bin/* /usr/local/bin/
WORKDIR /shellspec
RUN echo "--no-banner" > /home/user/.shellspec \
 && [ "$(id -u)" -ne 0 ] || ln -s /usr/local/bin/fake-sudo.sh /usr/local/bin/sudo \
 && sudo ln -s /usr/local/bin/fake-nc.sh /usr/local/bin/nc \
 && sudo ln -s /shellspec/shellspec /usr/local/bin/shellspec \
 && sudo sh -c "echo $SH > /etc/invokesh.conf" \
 && [ "$SH" = "sh" ] || sudo ln -snf /usr/local/bin/invokesh /bin/sh

ENTRYPOINT [ "/shellspec/docker/entrypoint.sh" ]
CMD [ "shellspec" ]

COPY --chown=user:user ./ /shellspec
